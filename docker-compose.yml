version: '3.9'

services:

  sqldata:
    image: postgres:17-alpine

  nosqldata:
    image: mongo:latest

  cachedata:
    image: redis:alpine

  messagequeue:
    image: rabbitmq:4-management-alpine

  fluentd:
    build:
      context: .
      dockerfile: docker/fluentd/Dockerfile

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0

  kibana:
    image: docker.elastic.co/kibana/kibana:8.17.0

  jaeger:
    image: jaegertracing/jaeger:latest

  dapr-dashboard:
    image: daprio/dashboard:latest

  keycloak:
    image: quay.io/keycloak/keycloak:latest

  identity-api:
    image: ${REGISTRY:-donut}/identity.api:${TAG:-latest}
    build:
      context: .
      dockerfile: src/SomeSandwich.Donut.Identity/Dockerfile
    depends_on:
      - keycloak

  identity-api-dapr:
    image: "daprio/daprd:1.9.4"
    network_mode: "service:identity-api"
    depends_on:
      - identity-api

  link-api:
    image: ${REGISTRY:-donut}/link.api:${TAG:-latest}
    build:
      context: .
      dockerfile: src/SomeSandwich.Donut.Link/Dockerfile
    depends_on:
      - nosqldata
      - cachedata
      - messagequeue

  link-api-dapr:
    image: "daprio/daprd:1.9.4"
    network_mode: "service:link-api"
    depends_on:
      - link-api
